# **行动计划C：根本原因修复**

## **1\. 背景与当前状态**

我们已成功完成“行动计划B”，并取得了根本性的发现：

1. **确认了核心Bug**：main.exe绕过了我们设计的WhisperCppEncoder适配器层，导致转录逻辑不完整。  
2. **发现了潜在的参数错误**：--max-len 1参数极有可能限制了whisper.cpp生成有效结果。

我们已经从“问题定位”阶段，进入了“问题修复”阶段。

## **2\. 任务C的主要目标**

**修正main.exe中的代码执行路径，确保它能正确地创建并使用我们的WhisperCppEncoder适配器，并移除有问题的启动参数，最终输出正确的转录结果。**

## **3\. 关键任务分解**

| 任务 ID | 关键任务 | 状态 |
| :---- | :---- | :---- |
| **C.1** | **代码路径修正** | ⬜ 未开始 |
| **C.2** | **命令行参数修正** | ⬜ 未开始 |
| **C.3** | **功能验证** | ⬜ 未开始 |

### **任务C.1详解：代码路径修正**

* **目标**：在main.cpp或其依赖的实现中，找到创建iContext实例的地方，并强制其使用我们的新实现。  
* **具体步骤**：  
  1. **设置断点**：在main.cpp的main函数中，以及任何看起来像在创建Whisper上下文的地方设置断点。  
  2. **单步调试**：启动main.exe的调试会话，跟踪程序的执行流程。  
  3. **定位创建点**：找到CoCreateInstance或类似的函数调用，或者直接new一个Context实现的地方。  
  4. **分析逻辑**：查看是否有基于命令行参数（如 \-impl gpu）来选择不同实现的逻辑。  
  5. **强制修改**：修改这部分代码，确保无论如何，都会走到创建包含WhisperCppEncoder的那个ContextImpl版本。**这可能是最直接、最关键的一处修改。** 我们要确保 ModelImpl::createContext() 和 ContextImpl::runFullImpl() 中的日志能够被打印出来。

### **任务C.2详解：命令行参数修正**

* **目标**：从main.exe的调试启动参数中，移除或修正--max-len 1。  
* **具体步骤**：  
  1. 在Visual Studio中，右键点击main项目 \-\> Properties。  
  2. 导航到 Debugging 选项卡。  
  3. 在 Command Arguments 字段中，找到并删除 \--max-len 1 这个参数。  
  4. 或者，可以暂时在这里硬编码所有需要的参数，以确保测试环境的一致性。例如：-m "path/to/model.bin" \-f "path/to/jfk.wav"。

### **任务C.3详解：功能验证**

* **目标**：在完成C.1和C.2的修改后，验证转录功能是否恢复正常。  
* **具体步骤**：  
  1. 清理并重新编译整个解决方案。  
  2. 再次以Debug模式运行main.exe。  
  3. **检查日志**：首先确认我们新增的、位于WhisperCppEncoder和ContextImpl中的日志**现在能够被打印出来**。  
  4. **检查输出**：查看控制台的输出，确认是否出现了正确的转录文本。

## **4\. 任务C的验收标准**

**唯一且明确的标准**：

**在Debug模式下运行 main.exe 处理一个标准的 .wav 文件（如jfk.wav），能够在控制台**打印出正确的、非空的转录文本\*\*。\*\*