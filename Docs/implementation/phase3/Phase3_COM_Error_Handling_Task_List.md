# 里程碑 P3 任务清单 - 强化COM接口与错误处理

## 🎯 交付成果
Const-me引擎的COM接口将提供清晰、可操作的错误信息，并通过特定的HRESULT错误码和C#强类型异常，显著提升C#/.NET用户的开发体验和问题排查效率。

## 🛠️ 任务分解与状态 (Task Breakdown & Status)

---
### 子任务 P3.1: 定义特定HRESULT错误码 `估算点数: 3 pt`

*   **目标**: 识别并定义一套针对模型加载、量化和推理过程中常见错误的特定HRESULT错误码。
*   **验收标准**: 
    *   在共享头文件（如`Whisper/API/iContext.h`或新的错误定义文件）中，定义至少5个以上具有明确语义的`MAKE_HRESULT`错误码。
    *   每个错误码都应有清晰的注释，说明其代表的错误类型。
    *   错误码的FACILITY应设置为`FACILITY_ITF`。

#### 具体步骤 (Checklist):
-   [ ] **错误场景识别**: 梳理模型加载（格式不支持、文件损坏）、量化（未知量化类型）、推理（GPU内存不足、架构不匹配）等过程中可能出现的具体错误场景。
-   [ ] **HRESULT错误码定义**: 根据识别的错误场景，使用`MAKE_HRESULT`宏定义新的HRESULT错误码，并确保其唯一性。
-   [ ] **错误信息映射结构**: 设计一个C++结构（例如`ErrorInfo`），用于将HRESULT错误码映射到可读的错误消息和建议。
-   [ ] **文档化**: 在代码中为每个错误码添加详细注释，并在技术文档中更新错误码列表。

---
### 子任务 P3.2: C++端返回特定错误码 `估算点数: 5 pt`

*   **目标**: 修改Const-me引擎的C++代码，在检测到特定错误时，返回P3.1中定义的HRESULT错误码，而非通用的`E_FAIL`。
*   **验收标准**: 
    *   至少在3个关键错误路径（例如，模型加载失败、量化类型不匹配、GPU资源分配失败）中，替换原有的`E_FAIL`或通用错误码，返回新定义的特定HRESULT错误码。
    *   通过单元测试或集成测试，验证C++端能够正确地抛出这些特定错误码。

#### 具体步骤 (Checklist):
-   [ ] **模型加载器修改**: 在`modelFactory.cpp`或相关模型加载逻辑中，识别模型格式不支持、文件损坏等错误点，并返回`E_MODEL_FORMAT_NOT_SUPPORTED`等特定错误码。
-   [ ] **量化操作修改**: 在`QuantizationOps.cpp`中，如果遇到未知的量化类型或GPU解量化失败，返回`E_MODEL_QUANTIZATION_UNKNOWN`或`E_GPU_DEQUANTIZATION_FAILED`。
-   [ ] **GPU资源管理修改**: 在DirectCompute相关的GPU资源分配代码中，如果遇到内存不足等问题，返回`E_INSUFFICIENT_GPU_MEMORY`。
-   [ ] **错误传播**: 确保这些特定错误码能够正确地从底层函数传播到COM接口的边界。
-   [ ] **测试用例更新**: 编写或更新测试用例，模拟这些错误场景，并验证返回的HRESULT错误码是否符合预期。

---
### 子任务 P3.3: C#端处理特定错误并映射为强类型异常 `估算点数: 8 pt`

*   **目标**: 在C#/.NET包装器中，捕获C++端返回的特定HRESULT错误码，并将其映射为用户友好的强类型异常，提供清晰的错误消息和解决建议。
*   **验收标准**: 
    *   定义至少3个C#强类型异常类（例如，`ModelFormatException`，`QuantizationException`，`GpuResourceException`），继承自`Exception`。
    *   在C#包装器中，实现COM异常捕获逻辑，根据HRESULT值将COM异常转换为对应的强类型异常。
    *   每个强类型异常都应包含从C++错误信息映射而来的用户友好消息和建议。
    *   通过C#测试用例，验证当C++端返回特定错误时，C#端能够捕获到正确的强类型异常。

#### 具体步骤 (Checklist):
-   [ ] **C#异常类定义**: 在C#项目中定义新的强类型异常类，并添加构造函数以接受错误消息和内部异常。
-   [ ] **COM异常捕获**: 在C#包装器中（例如，`WhisperContext.cs`），使用`try-catch`块捕获`System.Runtime.InteropServices.COMException`。
-   [ ] **HRESULT映射**: 在`catch`块中，根据`COMException.HResult`的值，使用`switch`语句或`if-else`结构，将HRESULT映射到对应的C#强类型异常。
-   [ ] **错误消息和建议**: 从C++端定义的错误信息映射结构中获取用户友好的错误消息和建议，并将其传递给C#异常。
-   [ ] **测试用例编写**: 编写C#测试用例，模拟C++端抛出特定错误码的场景（例如，尝试加载一个不存在的模型文件），并验证C#端是否捕获到正确的强类型异常和错误消息。
-   [ ] **文档更新**: 更新C#/.NET API文档，说明新的异常类型及其使用方式。

--- 

## ✅ 本里程碑验收标准 (DoD)

### 必须达成 (Go/No-Go决策点)

-   [ ] **P3.1 错误码定义**: 至少5个具有明确语义的特定HRESULT错误码已定义并文档化。
-   [ ] **P3.2 C++错误返回**: 至少3个关键错误路径已修改为返回特定HRESULT错误码，并通过测试验证。
-   [ ] **P3.3 C#异常映射**: 至少3个C#强类型异常类已定义，并在C#包装器中实现HRESULT到强类型异常的正确映射，并通过测试验证。
-   [ ] **用户体验提升**: C#/.NET用户在遇到模型加载或量化相关错误时，能够获得清晰、具体的错误消息和解决建议，而非通用的COM错误。

### 期望达成 (Stretch Goals)

-   [ ] 🎯 **P3.4 错误信息本地化**: 为核心错误信息提供多语言本地化支持。
-   [ ] 🎯 **P3.5 错误日志增强**: 在C++端，当返回特定错误码时，同时记录更详细的内部错误日志，便于调试。

### 关键风险应对预案

-   **若 [HRESULT错误码冲突]**: `立即行动：检查错误码的FACILITY和CODE部分，确保其在COM接口范围内是唯一的，并避免与系统定义的HRESULT冲突。`
-   **若 [C++错误传播中断]**: `立即行动：使用Visual Studio调试器，在C++错误发生点设置断点，并跟踪HRESULT的返回值，确保其能正确传播到COM接口边界。`
-   **若 [C#异常映射不正确]**: `立即行动：仔细核对C++ HRESULT值与C#异常映射的对应关系，确保unchecked((int)0x...)的转换正确无误。`

---

## 💡 经验沉淀 (Lessons Learned)

*   **遇到的问题**: *[待团队填写]*
*   **最佳实践**: *[待团队填写]*
*   **对后续里程碑的建议**: *[待团队填写]*

---

## 📁 交付物清单

### 1. 代码与工件 (Code & Artifacts)
-   包含新HRESULT错误码定义的头文件。
-   修改后的C++模型加载、量化和GPU资源管理代码。
-   新的C#强类型异常类定义。
-   修改后的C#/.NET包装器代码，实现HRESULT到强类型异常的映射。
-   用于验证错误处理逻辑的C++和C#测试用例。

### 2. 测试报告与数据 (Test Reports & Data)
-   C++端特定HRESULT错误码返回的功能测试报告。
-   C#端强类型异常映射的功能测试报告。

### 3. 文档与知识沉淀 (Documentation & Knowledge)
-   本阶段的技术实施总结报告。
-   HRESULT错误码列表及其含义的详细文档。
-   C#/.NET API文档中关于新异常类型的使用说明。
-   本阶段遇到的主要问题、解决方案和经验教训。
-   对下一阶段的具体实施建议。

---

## 📅 时间线与资源 (Timeline & Resources)

*   **预计持续时间**: 1周
*   **核心开发人员**: 1名C++开发工程师，1名C#开发工程师（可兼任）
*   **所需硬件/软件**: Visual Studio 2022，.NET开发环境。

---

## 🤝 协作与沟通 (Collaboration & Communication)

*   **每日站会**: 同步进度，识别障碍。
*   **每周技术评审**: 深入讨论技术方案，解决复杂问题。
*   **C++/C#接口联调**: 密切协作，确保跨语言错误处理的正确性。

---

## 风险管理 (Risk Management)

*   **风险**: HRESULT错误码定义不规范，导致与系统或其他COM组件冲突。
*   **缓解措施**: 严格遵循COM HRESULT定义规范，使用`MAKE_HRESULT`宏，并选择合适的FACILITY。
*   **应急预案**: 若发生冲突，立即重新分配错误码，并更新所有相关代码和文档。

---

## 附录 (Appendix)

*   COM HRESULT定义规范参考文档链接。
*   C#/.NET中COM异常处理的最佳实践。

---
