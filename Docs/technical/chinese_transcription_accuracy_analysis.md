# 中文音频转录准确性问题技术分析

## 问题概述

**目标**：使中文音频转录结果与参考结果 `Tests/Audio/ggml-small/zh_short_audio.txt` 完全一致

**当前状态**：已解决无限循环采样问题，但转录准确性和分段策略仍有显著差异

## 参考结果 vs 当前结果对比

### 参考结果（目标）
```
10分钟就能吃上下饭菜
茄子 辣椒 细红柿
烤箱180度烤10分钟
好好的茄子保鲜膜包起来
一撕去皮超级简单快
所以茄子给它撕开
西红柿去皮用刀在
直接剪碎
前面真的一对
们见到上这个调好的料
真的加点一下
再来一点这个茄子油
这个大家有了
而且
```

**特征**：
- 16个短句
- 每句2-10个字符
- 内容准确，语义清晰
- 描述烹饪过程（茄子、西红柿处理）

### 当前结果
```
[00:00:00.080 --> 00:00:12.040]  不用开火十分钟就能吃上下飯菜节子啦叫西方式考相一百八十度考十分钟好好的节子保先魔国起来一秒去皮超及簡單快
[00:00:12.040 --> 00:00:25.300]  所啦叫给他思开西方式去皮用讲到直接见睡前接真言一对们健到上这个調好的料真儿加班一下再来一点这个啦叫油這個大家有落而不
```

**特征**：
- 2个长段
- 每段约60-70个字符
- 部分词汇正确（"十分钟"、"一百八十度"、"去皮"、"調好的料"）
- 存在识别错误和语义混乱

## 已尝试的解决方案

### 1. 动态时间戳采样策略调整

#### 1.1 激进动态采样（失败）
- **实现**：直接移植原项目逻辑 `sum_ts > max_tx`
- **结果**：无限循环采样相同时间戳token
- **原因**：我们环境中时间戳概率总是远高于文本概率

#### 1.2 保守动态采样（部分成功）
- **实现**：`(sum_ts > max_tx * 10.0) && (sum_ts > 0.05)`
- **结果**：避免无限循环，但分段仍不理想
- **问题**：过于保守，很少触发时间戳采样

#### 1.3 平衡动态采样（失败）
- **实现**：`(sum_ts > max_tx * 5.0) || (sum_ts > 0.03)`
- **结果**：又回到无限循环问题
- **原因**：仍然过于激进

#### 1.4 完全禁用动态采样（当前状态）
- **实现**：完全移除动态时间戳强制逻辑
- **结果**：稳定运行，生成2个长段
- **问题**：分段粒度过粗，准确性不足

### 2. 概率分布分析

**发现的关键数据**：
- 我们的环境：`sum_ts ≈ 0.029` (2.9%), `max_tx ≈ 0.00002` (0.002%)
- 比例约1400:1，但绝对值都很低
- 原项目的简单逻辑在我们环境中不适用

## 根本原因分析

### 1. 环境差异（已排除）
- ✅ 模型文件相同：`Tests/Models/ggml-small.bin`
- ✅ 音频文件相同：`Tests/Audio/zh_short_audio.mp3`
- ✅ 语言设置相同：`-l zh`

### 2. 分段机制差异（核心问题）

#### 原项目分段逻辑
```cpp
// 原项目依赖三种机制：
// 1. 模型自然生成 token_eot (50258) 结束段落
// 2. 动态时间戳采样在适当时候触发
// 3. 特殊token过滤 (token_sot, token_solm, token_not)
```

#### 我们的问题
- **动态采样失效**：概率分布差异导致原逻辑不适用
- **token_eot生成不足**：模型很少自然生成结束标记
- **段落过长**：缺乏有效的分段触发机制

### 3. 转录准确性问题

#### 可能原因
1. **解码参数差异**：温度、top-k、top-p等参数可能不同
2. **采样策略影响**：禁用动态采样可能影响了模型的正常行为
3. **语言约束处理**：中文语言约束可能没有正确应用
4. **词汇表处理**：特殊token处理可能有差异

## 下一步调查方向

### 1. 解码参数对比 ✅
- [x] 对比原项目和我们的解码参数设置
- [x] 检查温度、top-k、top-p等采样参数
- [x] 验证语言token设置是否正确

#### 参数对比结果
**关键发现：我们添加了额外的 `max_initial_ts` 限制**

我们的设置：
```cpp
rdi->max_initial_ts = 1.0f;  // CRITICAL: Limit initial timestamp to 1 second
```

原项目：没有设置此参数，使用默认值

**其他参数对比**：
- `thold_pt = 0.01f` ✅ 相同
- `thold_ptsum = 0.01f` ✅ 相同
- `n_max_text_ctx = 16384` ✅ 相同
- 采样策略：Greedy ✅ 相同
- 语言设置：通过命令行 `-l zh` ✅ 相同

**可能影响**：`max_initial_ts` 可能限制了模型生成时间戳的行为

#### 测试结果：移除 `max_initial_ts` 参数
- **结果**：❌ 完全失败
- **现象**：只生成2个时间戳token，没有任何文本内容，输出文件为空
- **处理token数**：53个（vs 正常的155个）
- **运行时间**：1.03秒（vs 正常的2.4秒）
- **结论**：`max_initial_ts = 1.0f` 对我们的实现是**关键必需的**

#### 🚨 重大发现：参数转换缺失
- **问题**：`max_initial_ts` 参数在转换函数中缺失！
- **位置**：`Whisper/source.compat/convertThings.cpp`
- **影响**：我们设置的 `max_initial_ts = 1.0f` 没有传递给 whisper.cpp
- **修复**：在 `makeOldParams` 和 `makeNewParams` 中添加参数转换
- **代码**：
  ```cpp
  res.max_initial_ts = rsi.max_initial_ts;  // CRITICAL: Transfer max_initial_ts parameter
  ```

#### 🎉 修复结果：重大突破！
- **状态**：✅ **中文转录基本成功**
- **处理token数**：155个（vs 之前的53个）
- **运行时间**：2.55秒（正常）
- **分段结果**：两个时间段，总共25.3秒
- **转录内容**：
  ```
  [00:00:00.080 --> 00:00:12.040] 不用开火十分钟就能吃上下飯菜节子啦叫西方式考相一百八十度考十分钟好好的节子保先魔国起来一秒去皮超及簡單快
  [00:00:12.040 --> 00:00:25.300] 所啦叫给他思开西方式去皮用讲到直接见睡前接真言一对们健到上这个調好的料真儿加班一下再来一点这个啦叫油這個大家有落而不
  ```
- **控制台显示**：显示为问号是Windows控制台UTF-8编码问题，实际文件内容正确

### 2. 特殊Token处理分析
- [ ] 详细分析原项目的特殊token过滤逻辑
- [ ] 检查我们的实现是否正确处理了所有特殊token
- [ ] 验证token_eot的生成和处理机制

### 3. 分段策略重新设计
- [ ] 研究原项目的自然分段机制
- [ ] 设计适合我们环境的动态采样策略
- [ ] 考虑基于音频特征的分段方法

### 4. 逐步对比调试
- [ ] 使用相同音频在原项目中运行，对比详细的token生成过程
- [ ] 分析每个token的概率分布差异
- [ ] 找出导致不同行为的关键节点

## 技术发现记录

### 重要发现1：动态采样环境差异
- 原项目的简单逻辑 `sum_ts > max_tx` 在我们环境中总是为真
- 这表明我们的概率分布与原项目有根本性差异
- 需要深入分析造成这种差异的原因

### 重要发现2：自然分段机制失效
- 原项目依赖模型自然生成token_eot来分段
- 我们的模型很少生成token_eot，导致段落过长
- 这可能与动态采样的禁用有关

### 重要发现3：部分词汇识别正确
- "十分钟"、"一百八十度"、"去皮"等词汇识别正确
- 说明基础的语音识别能力是正常的
- 问题可能在于语言模型的约束和采样策略

## 状态追踪

- ✅ 解决无限循环采样问题
- ✅ 确认基础转录功能正常
- ❌ 转录准确性不足
- ❌ 分段策略不正确
- 🔄 正在调查根本原因

## 下次更新计划

1. 深入分析解码参数差异
2. 对比原项目的详细token生成过程
3. 设计新的分段策略
4. 逐步验证每个改进的效果
