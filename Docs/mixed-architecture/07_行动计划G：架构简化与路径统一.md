# **行动计划G：架构简化与路径统一**

## **1\. 背景与最终诊断**

经过多轮详细的调试和您最新提供的《项目结构分析报告》，我们已最终确认：所有问题的根源并非某个孤立的Bug，而是项目同时维护“原生DirectCompute引擎”和“新whisper.cpp引擎”这两种实现所带来的**架构性复杂和混乱**。我们必须做出取舍，进行彻底的简化。

## **2\. 任务G的战略目标**

**以“移除原生引擎，独尊新版引擎”为核心原则，对项目进行一次外科手术式的架构简化，彻底消除“双重实现”带来的所有不确定性，创建一个干净、统一、可预测的代码环境，并最终使main.exe成功输出转录文本。**

## **3\. 关键任务分解**

这是一次以“删除”和“简化”为核心的重构工作，目的是让我们的代码库变得更小、更清晰。

| 任务 ID | 关键任务 | 状态 |
| :---- | :---- | :---- |
| **G.1** | **架构冻结与隔离：废除原生引擎** | ⬜ 未开始 |
| **G.2** | **接口层重构：强制统一路径** | ⬜ 未开始 |
| **G.3** | **依赖与构建清理** | ⬜ 未开始 |
| **G.4** | **重新编译与基线测试** | ⬜ 未开始 |

### **任务G.1详解：架构冻结与隔离：废除原生引擎**

* **目标**：在代码层面，彻底“关闭”原生的DirectCompute引擎，使其无法被编译和调用。  
* **战术**：使用预处理器宏进行大规模的代码隔离。这比直接删除代码更安全，便于未来参考。  
* **步骤**：  
  1. 在一个全局性的配置文件或pch.h中，定义一个宏，例如 \#define WHISPER\_NG\_USE\_ONLY\_CPP\_IMPLEMENTATION 1。  
  2. 找到与原生GPU实现高度相关的代码块和文件，用 \#if \!WHISPER\_NG\_USE\_ONLY\_CPP\_IMPLEMENTATION ... \#endif 将其包裹起来。重点关注：  
     * Whisper/D3D/, Whisper/ML/ 目录下的实现。  
     * 加载和调度HLSL计算着色器的相关代码。  
     * ModelImpl.cpp和ContextImpl.cpp中，所有不属于WhisperCppEncoder路径的逻辑分支。

### **任务G.2详解：接口层重构：强制统一路径**

* **目标**：移除所有用于在“原生引擎”和“新引擎”之间进行选择的逻辑，强制所有调用都必须走WhisperCppEncoder路径。  
* **步骤**：  
  1. 找到ModelImpl::createContext()或类似函数中，根据eModelImplementation（GPU/CPU/Hybrid）来创建不同Context的if/else或switch逻辑。  
  2. **彻底删除这些选择逻辑**。将其简化为唯一的一行代码：总是创建那个使用了WhisperCppEncoder的ContextImpl实例。  
  3. 现在，eModelImplementation这个枚举类型可能已经失去了它的作用，可以考虑将其废弃。

### **任务G.3详解：依赖与构建清理**

* **目标**：根据代码的简化，清理项目文件和构建脚本中的冗余依赖。  
* **步骤**（在Visual Studio中操作）：  
  1. 打开Whisper.dll等核心项目的属性。  
  2. 从链接器设置中，移除所有仅被原生引擎使用的库（如果存在）。  
  3. 从项目文件中，移除对已隔离的.cpp和.h文件的引用。  
  4. 检查构建脚本（如Tools/CompressShaders/），由于我们不再使用原生计算着色器，这些工具和步骤可以被禁用或移除。

### **任务G.4详解：重新编译与基线测试**

* **目标**：在一个经过大幅简化的、干净的代码库上，重新进行我们的基线功能测试。  
* **步骤**：  
  1. 执行一次完整的“Clean Solution”和“Rebuild Solution”。  
  2. 此时可能会出现一些由于我们大胆修改而产生的新的编译错误。逐一修复它们，这些错误通常是逻辑不一致的明确信号。  
  3. 一旦编译通过，立即以Debug模式运行main.exe，并使用我们之前所有的调试手段（日志、断点）来观察其行为。

## **4\. 预期成果与验收标准**

### **预期成果**

* 一个更小、更简单、更易于理解和维护的代码库。  
* 消除了所有关于“当前到底走了哪条路”的困惑。  
* 由于复杂性大幅降低，之前隐藏的Bug（如whisper\_full调用失败）极有可能已经消失，或者其根本原因会变得异常清晰。

### **最终验收标准**

**在完成架构简化和重构后，运行我们修复后的 main.exe 处理 jfk.wav 文件，能够在控制台打印出正确的、非空的转录文本。**